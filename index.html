<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Syllabus Generator - Purdue University Global</title>

    <style>
        /* Purdue University Color Scheme */
        :root {
            --campus-gold: #C28E0E;
            --athletic-gold: #CEB888;
            --purdue-black: #000000;
            --gray: #9D968D;
            --dark-gray: #373A36;
            --white: #FFFFFF;
            --light-bg: #F8F8F8;
            --border-color: #E0E0E0;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: var(--light-bg);
            color: var(--purdue-black);
            line-height: 1.6;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            min-height: 100vh;
            display: flex;
            flex-direction: column;
        }

        /* Header */
        header {
            text-align: center;
            padding: 40px 20px;
            background: linear-gradient(135deg, var(--purdue-black) 0%, var(--dark-gray) 100%);
            border-radius: 12px;
            margin-bottom: 30px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.3);
        }

        header h1 {
            color: var(--campus-gold);
            font-size: 2.5em;
            margin-bottom: 10px;
            font-weight: 700;
            text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.3);
        }

        .subtitle {
            color: var(--white);
            font-size: 1.1em;
            opacity: 0.95;
        }

        /* Main Content */
        main {
            flex: 1;
            background: var(--white);
            padding: 40px;
            border-radius: 12px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08);
        }

        /* Upload Section */
        .upload-section {
            text-align: center;
        }

        .upload-box {
            border: 3px dashed var(--gray);
            border-radius: 12px;
            padding: 28px 24px;
            transition: all 0.3s ease;
            cursor: pointer;
            background-color: var(--light-bg);
        }

        .upload-box:hover {
            border-color: var(--campus-gold);
            background-color: #FFF9E6;
        }

        .upload-box.dragover {
            border-color: var(--campus-gold);
            background-color: #FFF9E6;
            transform: scale(1.02);
        }

        .upload-icon {
            width: 56px;
            height: 56px;
            color: var(--campus-gold);
            margin-bottom: 20px;
        }

        .upload-box h2 {
            color: var(--dark-gray);
            margin-bottom: 10px;
            font-size: 1.8em;
        }

        .upload-box p {
            color: var(--gray);
            margin-bottom: 20px;
            font-size: 1.1em;
        }

        .upload-box.secondary {
            margin-top: 25px;
        }

        .standard-language-option {
            margin: 20px 0 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            color: var(--dark-gray);
            font-weight: 600;
        }

        .standard-language-option input[type="checkbox"] {
            width: 18px;
            height: 18px;
            accent-color: var(--campus-gold);
            cursor: pointer;
        }

        /* File List */
        .file-list {
            margin: 30px 0;
            text-align: left;
        }

        .file-item {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 15px 20px;
            background-color: var(--light-bg);
            border-left: 4px solid var(--campus-gold);
            border-radius: 8px;
            margin-bottom: 10px;
        }

        .file-name {
            font-weight: 600;
            color: var(--dark-gray);
        }

        .file-remove {
            background: none;
            border: none;
            color: #dc3545;
            cursor: pointer;
            font-size: 1.2em;
            padding: 5px 10px;
        }

        .file-remove:hover {
            opacity: 0.7;
        }

        /* Buttons */
        .btn-primary,
        .btn-secondary {
            padding: 12px 30px;
            border: none;
            border-radius: 8px;
            font-size: 1em;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            display: inline-flex;
            align-items: center;
            gap: 8px;
        }

        .btn-primary {
            background-color: var(--campus-gold);
            color: var(--white);
        }

        .btn-primary:hover {
            background-color: #A67700;
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(194, 142, 14, 0.3);
        }

        .btn-primary:disabled {
            background-color: var(--gray);
            cursor: not-allowed;
            box-shadow: none;
            transform: none;
            opacity: 0.7;
        }

        .btn-secondary {
            background-color: var(--gray);
            color: var(--white);
        }

        .btn-secondary:hover {
            background-color: var(--dark-gray);
            transform: translateY(-2px);
        }

        .btn-large {
            padding: 15px 40px;
            font-size: 1.1em;
            margin-top: 20px;
        }

        .btn-primary svg,
        .btn-secondary svg {
            width: 20px;
            height: 20px;
        }

        /* Results Section */
        .results-section {
            animation: fadeIn 0.5s ease-in;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(20px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .results-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding: 20px;
            background: linear-gradient(135deg, var(--purdue-black) 0%, var(--dark-gray) 100%);
            border-radius: 8px;
        }

        .results-header h2 {
            color: var(--campus-gold);
            font-size: 1.8em;
            margin: 0;
        }

        .results-stats {
            display: flex;
            gap: 20px;
        }

        .stat {
            color: var(--white);
            font-size: 1em;
        }

        .stat strong {
            color: var(--campus-gold);
            font-size: 1.5em;
            margin-right: 5px;
        }

        /* Table */
        .results-table-container {
            overflow-x: auto;
            margin-bottom: 30px;
            border-radius: 8px;
            border: 1px solid var(--border-color);
        }

        .results-table {
            width: 100%;
            border-collapse: collapse;
            background-color: var(--white);
        }

        .results-table thead {
            background-color: var(--campus-gold);
            color: var(--white);
        }

        .results-table th {
            padding: 15px;
            text-align: left;
            font-weight: 600;
            font-size: 1em;
        }

        .results-table tbody tr {
            border-bottom: 1px solid var(--border-color);
            transition: background-color 0.2s ease;
        }

        .results-table tbody tr:hover {
            background-color: #FFF9E6;
        }

        .results-table td {
            padding: 12px 15px;
            color: var(--dark-gray);
        }

        .results-table td:first-child {
            font-weight: 600;
            color: var(--campus-gold);
        }

        .results-table td:nth-child(2) {
            text-align: center;
            font-weight: 600;
        }

        /* Actions */
        .actions {
            display: flex;
            gap: 15px;
            justify-content: center;
            margin-bottom: 30px;
            padding-bottom: 20px;
            border-bottom: 2px solid var(--border-color);
        }

        /* Collapsible Course Sections */
        .course-section {
            margin-bottom: 20px;
            border: 2px solid var(--dark-gray);
            border-radius: 8px;
            background-color: var(--white);
            overflow: hidden;
        }

        .course-header {
            background: linear-gradient(135deg, var(--purdue-black) 0%, var(--dark-gray) 100%);
            color: var(--white);
            padding: 15px 20px;
            cursor: pointer;
            display: flex;
            justify-content: space-between;
            align-items: center;
            transition: background 0.3s ease;
        }

        .course-header:hover {
            background: linear-gradient(135deg, var(--dark-gray) 0%, var(--gray) 100%);
        }

        .course-header h3 {
            margin: 0;
            font-size: 1.2em;
            color: var(--campus-gold);
        }

        .course-header .course-count {
            background-color: var(--campus-gold);
            color: var(--purdue-black);
            padding: 4px 12px;
            border-radius: 12px;
            font-weight: 600;
            font-size: 0.9em;
        }

        .course-toggle {
            color: var(--white);
            font-size: 1.5em;
            transition: transform 0.3s ease;
        }

        .course-toggle.expanded {
            transform: rotate(180deg);
        }

        .course-content {
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.3s ease;
        }

        .course-content.expanded {
            max-height: 5000px;
        }

        .course-table-container {
            padding: 20px;
            background-color: var(--light-bg);
        }

        /* Validation Warning */
        .validation-warning {
            background-color: #FFF3CD;
            border: 2px solid #FFC107;
            border-radius: 8px;
            padding: 15px 20px;
            margin-bottom: 20px;
            display: flex;
            align-items: flex-start;
            gap: 12px;
        }

        .validation-warning-icon {
            color: #856404;
            font-size: 24px;
            line-height: 1;
            flex-shrink: 0;
        }

        .validation-warning-content {
            flex: 1;
        }

        .validation-warning-title {
            color: #856404;
            font-weight: 600;
            font-size: 1.1em;
            margin: 0 0 8px 0;
        }

        .validation-warning-text {
            color: #856404;
            margin: 0;
            line-height: 1.5;
        }

        .validation-warning-missing {
            font-weight: 600;
            color: #721c24;
        }

        /* Loading Spinner */
        .loading {
            text-align: center;
            padding: 60px 20px;
        }

        .spinner {
            border: 4px solid var(--athletic-gold);
            border-top: 4px solid var(--campus-gold);
            border-radius: 50%;
            width: 60px;
            height: 60px;
            animation: spin 1s linear infinite;
            margin: 0 auto 20px;
        }

        @keyframes spin {
            0% {
                transform: rotate(0deg);
            }

            100% {
                transform: rotate(360deg);
            }
        }

        .loading p {
            color: var(--gray);
            font-size: 1.1em;
        }

        /* Error Display */
        .error {
            background-color: #f8d7da;
            border: 1px solid #f5c6cb;
            color: #721c24;
            padding: 20px;
            border-radius: 8px;
            text-align: center;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 15px;
        }

        .error svg {
            width: 40px;
            height: 40px;
            flex-shrink: 0;
        }

        /* Footer */
        footer {
            text-align: center;
            padding: 20px;
            margin-top: 30px;
            color: var(--gray);
            font-size: 0.9em;
        }

        /* Responsive Design */
        @media (max-width: 768px) {
            header h1 {
                font-size: 1.8em;
            }

            main {
                padding: 20px;
            }

            .upload-box {
                padding: 22px 18px;
            }

            .results-header {
                flex-direction: column;
                align-items: flex-start;
                gap: 10px;
            }

            .actions {
                flex-direction: column;
            }

            .btn-primary,
            .btn-secondary {
                width: 100%;
                justify-content: center;
            }

            .results-table {
                font-size: 0.9em;
            }

            .results-table th,
            .results-table td {
                padding: 10px 8px;
            }
        }
    <style>
        /* ... existing styles ... */
    </style>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdfmake/0.2.7/pdfmake.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdfmake/0.2.7/vfs_fonts.js"></script>
</head>

<body>
    <div class="container">
        <header>
            <h1>Syllabus Generator</h1>
            <p class="subtitle">Generate a syllabus based on the course dev guide</p>
        </header>

        <main>
            <div class="upload-section">
                <div class="upload-box" id="uploadBox">
                    <svg class="upload-icon" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"
                        stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                            d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M15 13l-3-3m0 0l-3 3m3-3v12" />
                    </svg>
                    <h2>Upload Course Markdown Files</h2>
                    <p>Drag and drop your .md files here or click to browse</p>
                    <input type="file" id="fileInput" multiple accept=".md,.markdown" hidden>
                    <button class="btn-primary" id="browseBtn">Browse Files</button>
                </div>

                <div class="file-list" id="fileList"></div>

                <label class="standard-language-option" for="includeStandardLanguage">
                    <input type="checkbox" id="includeStandardLanguage">
                    Add standard syllabus language to the end of the document
                </label>

                <div class="upload-box secondary" id="standardUploadBox" style="display: none;">
                    <svg class="upload-icon" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"
                        stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                            d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M15 13l-3-3m0 0l-3 3m3-3v12" />
                    </svg>
                    <h2>Upload Standard Syllabus Language</h2>
                    <p>Upload a single .md file to append</p>
                    <input type="file" id="standardFileInput" accept=".md,.markdown" hidden>
                    <button class="btn-primary" id="standardBrowseBtn">Browse File</button>
                </div>

                <div class="file-list" id="standardFileList" style="display: none;"></div>

                <button class="btn-primary btn-large" id="processBtn" disabled>
                    Process Files
                </button>
            </div>

            <div class="results-section" id="resultsSection" style="display: none;">
                <div class="results-header">
                    <h2>Generated Syllabi</h2>
                    <button class="btn-secondary" id="resetBtn">
                        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15" />
                        </svg>
                        Start Over
                    </button>
                </div>

                <div id="syllabusResults"></div>
            </div>

            <div class="loading" id="loading" style="display: none;">
                <div class="spinner"></div>
                <p>Generating syllabi...</p>
            </div>

            <div class="error" id="error" style="display: none;">
                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                        d="M12 8v4m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
                </svg>
                <p id="errorMessage"></p>
            </div>
        </main>

        <footer>
            <p>&copy; 2025 Purdue University Global - Syllabus Generator | <strong>v3.0.0</strong></p>
        </footer>
    </div>

    <script>

        // Global variables
        let selectedFiles = [];
        let csvData = '';
        let standardLanguageFile = null;

        // DOM Elements
        const fileInput = document.getElementById('fileInput');
        const browseBtn = document.getElementById('browseBtn');
        const uploadBox = document.getElementById('uploadBox');
        const fileList = document.getElementById('fileList');
        const processBtn = document.getElementById('processBtn');
        const resultsSection = document.getElementById('resultsSection');
        const loading = document.getElementById('loading');
        const error = document.getElementById('error');
        const errorMessage = document.getElementById('errorMessage');
        const resetBtn = document.getElementById('resetBtn');
        const includeStandardLanguage = document.getElementById('includeStandardLanguage');
        const standardUploadBox = document.getElementById('standardUploadBox');
        const standardFileInput = document.getElementById('standardFileInput');
        const standardBrowseBtn = document.getElementById('standardBrowseBtn');
        const standardFileList = document.getElementById('standardFileList');

        // Event Listeners
        browseBtn.addEventListener('click', () => fileInput.click());
        fileInput.addEventListener('change', handleFileSelect);
        uploadBox.addEventListener('click', () => fileInput.click());
        uploadBox.addEventListener('dragover', handleDragOver);
        uploadBox.addEventListener('dragleave', handleDragLeave);
        uploadBox.addEventListener('drop', handleDrop);
        includeStandardLanguage.addEventListener('change', toggleStandardLanguageUpload);
        standardBrowseBtn.addEventListener('click', () => standardFileInput.click());
        standardFileInput.addEventListener('change', handleStandardFileSelect);
        standardUploadBox.addEventListener('click', () => standardFileInput.click());
        standardUploadBox.addEventListener('dragover', handleStandardDragOver);
        standardUploadBox.addEventListener('dragleave', handleStandardDragLeave);
        standardUploadBox.addEventListener('drop', handleStandardDrop);
        processBtn.addEventListener('click', processFiles);
        resetBtn.addEventListener('click', reset);

        // Handle file selection
        function handleFileSelect(e) {
            const files = Array.from(e.target.files);
            addFiles(files);
        }

        // Handle drag over
        function handleDragOver(e) {
            e.preventDefault();
            uploadBox.classList.add('dragover');
        }

        // Handle drag leave
        function handleDragLeave(e) {
            e.preventDefault();
            uploadBox.classList.remove('dragover');
        }

        // Handle drop
        function handleDrop(e) {
            e.preventDefault();
            uploadBox.classList.remove('dragover');
            const files = Array.from(e.dataTransfer.files).filter(file =>
                file.name.endsWith('.md') || file.name.endsWith('.markdown')
            );
            addFiles(files);
        }

        function toggleStandardLanguageUpload() {
            if (includeStandardLanguage.checked) {
                standardUploadBox.style.display = 'block';
                standardFileList.style.display = 'block';
            } else {
                standardUploadBox.style.display = 'none';
                standardFileList.style.display = 'none';
                standardLanguageFile = null;
                standardFileInput.value = '';
                updateStandardFileList();
            }
            updateProcessButton();
        }

        function handleStandardFileSelect(e) {
            const file = e.target.files[0];
            setStandardFile(file);
        }

        function handleStandardDragOver(e) {
            e.preventDefault();
            standardUploadBox.classList.add('dragover');
        }

        function handleStandardDragLeave(e) {
            e.preventDefault();
            standardUploadBox.classList.remove('dragover');
        }

        function handleStandardDrop(e) {
            e.preventDefault();
            standardUploadBox.classList.remove('dragover');
            const file = Array.from(e.dataTransfer.files).find(f =>
                f.name.endsWith('.md') || f.name.endsWith('.markdown')
            );
            setStandardFile(file || null);
        }

        function setStandardFile(file) {
            if (file && (file.name.endsWith('.md') || file.name.endsWith('.markdown'))) {
                standardLanguageFile = file;
            } else {
                standardLanguageFile = null;
                standardFileInput.value = '';
            }
            updateStandardFileList();
            updateProcessButton();
        }

        // Add files to the list
        function addFiles(files) {
            files.forEach(file => {
                // Accept .md and .markdown files
                if ((file.name.endsWith('.md') || file.name.endsWith('.markdown')) &&
                    !selectedFiles.find(f => f.name === file.name)) {
                    selectedFiles.push(file);
                }
            });

            updateFileList();
            updateProcessButton();
        }

        // Update file list display
        function updateFileList() {
            if (selectedFiles.length === 0) {
                fileList.innerHTML = '';
                return;
            }

            fileList.innerHTML = '<h3 style="color: var(--dark-gray); margin-bottom: 15px;">Selected Files:</h3>';

            selectedFiles.forEach((file, index) => {
                const fileItem = document.createElement('div');
                fileItem.className = 'file-item';
                fileItem.innerHTML = `
                    <span class="file-name">${file.name}</span>
                    <button class="file-remove" onclick="removeFile(${index})">&times;</button>
                `;
                fileList.appendChild(fileItem);
            });
        }

        function updateStandardFileList() {
            if (!standardLanguageFile) {
                standardFileList.innerHTML = '';
                return;
            }

            standardFileList.innerHTML = '<h3 style="color: var(--dark-gray); margin-bottom: 15px;">Standard Language File:</h3>';
            const fileItem = document.createElement('div');
            fileItem.className = 'file-item';
            fileItem.innerHTML = `
                <span class="file-name">${standardLanguageFile.name}</span>
                <button class="file-remove" onclick="clearStandardFile()">&times;</button>
            `;
            standardFileList.appendChild(fileItem);
        }

        function clearStandardFile() {
            standardLanguageFile = null;
            standardFileInput.value = '';
            updateStandardFileList();
            updateProcessButton();
        }

        // Remove a file from the list
        function removeFile(index) {
            selectedFiles.splice(index, 1);
            updateFileList();
            updateProcessButton();
        }

        // Update process button visibility
        function updateProcessButton() {
            const needsStandard = includeStandardLanguage.checked;
            const hasStandard = !needsStandard || !!standardLanguageFile;
            processBtn.style.display = 'inline-flex';
            processBtn.disabled = !(selectedFiles.length > 0 && hasStandard);
        }

        // Extract text from Markdown file
        async function extractTextFromMarkdown(file) {
            return await file.text();
        }

        // Extract course code from text
        function extractCourseCode(text) {
            const match = text.match(/\b([A-Z]{2}\d{3})\b/);
            return match ? match[1] : 'UNKNOWN';
        }

        // Validate if all expected units have outcomes
        function validateUnits(outcomes, courseCode, expectedUnits = 10) {
            const unitsFound = new Set();
            outcomes
                .filter(o => o.courseCode === courseCode)
                .forEach(o => unitsFound.add(parseInt(o.unit)));

            const missingUnits = [];
            for (let i = 1; i <= expectedUnits; i++) {
                if (!unitsFound.has(i)) {
                    missingUnits.push(i);
                }
            }

            return {
                isComplete: missingUnits.length === 0,
                unitsFound: Array.from(unitsFound).sort((a, b) => a - b),
                missingUnits: missingUnits,
                totalFound: unitsFound.size,
                totalExpected: expectedUnits
            };
        }

        // Extract outcomes from markdown text
        function extractOutcomes(text, courseCode) {
            const outcomes = [];
            const lines = text.split('\n');

            // Find all instances of the trigger phrase
            for (let i = 0; i < lines.length; i++) {
                const line = lines[i];

                // Check for the trigger phrase - this marks the start of outcomes for a unit
                if (line.match(/After\s+completing\s+this\s+unit.*you\s+should\s+be\s+able\s+to/i)) {
                    console.log(`Found trigger phrase at line ${i}: "${line.substring(0, 60)}..."`);

                    // Look backwards to find the unit number from the preceding header
                    let unitNumber = 'UNKNOWN';
                    for (let j = i - 1; j >= Math.max(0, i - 50); j--) {
                        const headerLine = lines[j];
                        // Look for "Unit X" headers at start of line (Overview/Reading/main header)
                        const unitMatch = headerLine.match(/^\s*#{0,6}\s*\*{0,2}\s*Unit\s+(\d+)\s*(?:Overview|Reading|:)/i);
                        if (unitMatch) {
                            unitNumber = unitMatch[1];
                            console.log(`Found unit number ${unitNumber} in header: "${headerLine.trim()}"`);
                            break;
                        }
                    }

                    // Extract bullet points that follow the trigger phrase
                    for (let k = i + 1; k < Math.min(i + 50, lines.length); k++) {
                        let currentText = lines[k].trim();

                        // Skip empty lines
                        if (currentText.length === 0) {
                            continue;
                        }

                        // Check if this line is a bullet point (markdown: - or • or *)
                        const bulletMatch = currentText.match(/^[-•*]\s+(.+)/);

                        if (bulletMatch) {
                            let outcome = bulletMatch[1].trim();
                            console.log(`Found bullet point: "${outcome.substring(0, 50)}..."`);

                            // Check if the outcome continues on the next lines (multi-line outcomes)
                            let nextLineIndex = k + 1;
                            while (nextLineIndex < lines.length) {
                                const nextLine = lines[nextLineIndex].trim();

                                // Stop if we hit empty line, another bullet, or a header, or any non-continuation text
                                if (nextLine.length === 0 ||
                                    nextLine.match(/^[-•*]\s+/) ||
                                    nextLine.match(/^#{1,6}\s/) ||
                                    nextLine.match(/^Unit\s+\d+/i)) {
                                    break;
                                }

                                // Continue the outcome
                                outcome += ' ' + nextLine;
                                k = nextLineIndex;  // Skip these lines in the main loop
                                nextLineIndex++;
                            }

                            // Only add if it's substantial
                            if (outcome.length > 5) {
                                outcomes.push({
                                    courseCode: courseCode,
                                    unit: unitNumber,
                                    outcome: outcome.trim()
                                });
                            }
                        } else {
                            // If we hit a non-empty, non-bullet line, we've left the outcomes section
                            console.log(`Stopping at non-bullet line ${k}: "${currentText.substring(0, 40)}..."`);
                            break;
                        }
                    }
                }
            }

            console.log(`Total outcomes found: ${outcomes.length}`);
            return outcomes;
        }

        // --- Syllabus Generation Functions ---

        const generateSyllabusBtn = document.getElementById('generateSyllabusBtn');
        if (generateSyllabusBtn) {
            generateSyllabusBtn.addEventListener('click', generateSyllabus);
        }

        async function generateSyllabus() {
            if (selectedFiles.length === 0) return;

            let standardLanguage = '';
            if (includeStandardLanguage.checked) {
                if (!standardLanguageFile) {
                    showError('Please upload the standard syllabus language .md file before generating.');
                    return;
                }
                standardLanguage = sanitizeStandardLanguage(await extractTextFromMarkdown(standardLanguageFile));
            }

            const file = selectedFiles[0];
            const text = await extractTextFromMarkdown(file);

            const courseInfo = extractCourseInfo(text);
            const intro = extractIntroSections(text);
            const outcomes = extractCourseOutcomes(text);
            const grading = extractGradebook(text);
            const unitOutcomes = extractUnitOutcomesForSyllabus(text, courseInfo.code);

            const syllabusMarkdown = createSyllabusMarkdown(courseInfo, intro, outcomes, grading, unitOutcomes, standardLanguage);
            downloadFile(syllabusMarkdown, `${courseInfo.code}_Syllabus.md`, 'text/markdown');
        }

        function extractCourseInfo(text) {
            const lines = text.split('\n');
            let info = { title: 'Unknown Course', code: 'UNKNOWN' };

            // Look for Course Code and Title
            for (const line of lines) {
                // Match both "**Course Code:** MM710" and "**Course Code: MM710**"
                // Also handles optional space after colon
                const codeMatch = line.match(/\*\*Course Code:?\**\s*(.+?)(?:\*\*|$)/i);
                if (codeMatch) {
                    // Clean up any trailing ** that might have been captured if the regex got greedy or structure was odd
                    let code = codeMatch[1].replace(/\*\*$/, '').trim();
                    if (code) info.code = code;
                }

                const titleMatch = line.match(/\*\*Course Title:\*\*\s*(.+)/i);
                if (titleMatch) info.title = titleMatch[1].trim();
            }
            // Fallback for Title in first line if not found
            if (info.title === 'Unknown Course' && lines.length > 0) {
                const titleHeader = lines[0].replace(/^#\s*\*\*/, '').replace(/\*\*$/, '').trim();
                if (titleHeader) info.title = titleHeader;
            }

            return info;
        }

        function extractIntroSections(text) {
            const sections = {
                whatLearn: '',
                howComplete: ''
            };

            // "What will I learn" extraction
            // Finding the specific cell content. The dev guide has a "Start Here" table.
            // We look for "WHAT WILL I LEARN?" and capture the text until the next specific header or cell end.
            // Updated regex: stop at "**HOW WILL I COMPLETE" or "|" or end of string, but NOT just any "**"
            const whatLearnMatch = text.match(/\*\*WHAT WILL I LEARN\?\*\*\s*([\s\S]*?)(?=\*\*HOW WILL I COMPLETE|\||$)/i);
            if (whatLearnMatch) {
                // Cleanup: remove newlines that are just wrapping, keep paragraph breaks
                sections.whatLearn = whatLearnMatch[1].replace(/\|/g, '').trim();
            }

            // "HOW WILL I COMPLETE THIS COURSE?"
            // Updated regex: stop at "|" or end of string (removed generic ** stop to be safe, though less critical here)
            const howCompleteMatch = text.match(/\*\*HOW WILL I COMPLETE THIS COURSE\?\*\*\s*([\s\S]*?)(?=\||$)/i);
            if (howCompleteMatch) {
                sections.howComplete = howCompleteMatch[1].replace(/\|/g, '').trim();
            }

            return sections;
        }

        function extractCourseOutcomes(text) {
            // Look for table after "CLA mapping for Build ONLY-"
            const mappingHeaderIndex = text.search(/\*\*CLA mapping for Build ONLY-\*\*/i);
            if (mappingHeaderIndex === -1) return [];

            const substring = text.substring(mappingHeaderIndex);
            const lines = substring.split('\n');
            const outcomes = [];

            let insideTable = false;

            for (let i = 0; i < lines.length; i++) {
                const line = lines[i].trim();

                // Stop at next section (e.g., "### CMS:" or "## ")
                if (line.startsWith('###') || line.startsWith('## ')) {
                    break;
                }

                // Detect table start (header row containing "Unit" and "CLA")
                if (line.includes('Unit') && line.includes('CLA') && line.startsWith('|')) {
                    insideTable = true;
                    continue; // skip header
                }

                // Skip separator rows (any row with :---- patterns)
                if (line.includes(':----')) {
                    continue;
                }

                if (insideTable) {
                    // Check if this is a table row
                    if (line.startsWith('|') && line.length > 5) {
                        // Split by '|' and get all parts (including empty ones initially)
                        const rawParts = line.split('|');
                        // Trim each part
                        const parts = rawParts.map(p => p.trim());

                        // Find the first non-empty part (this should be the outcome)
                        let outcomeText = '';
                        for (let j = 0; j < parts.length; j++) {
                            if (parts[j].length > 0) {
                                outcomeText = parts[j];
                                break;
                            }
                        }

                        if (outcomeText.length > 0) {
                            // Remove ALL ** markers from the text
                            let cleanedOutcome = outcomeText.replace(/\*\*/g, '');

                            // Check if this looks like a course outcome:
                            // - Pattern like GB700-1: or GB730-2: (letters, numbers, dash, number, colon)
                            // - Or PC pattern like PC 6.3: or PC6.3:
                            // - Updated to make colon optional (match space or colon separator)
                            if (cleanedOutcome.match(/^[A-Z]{2,}\d+-\d+(\s*:|\s+)/) ||
                                cleanedOutcome.match(/^PC\s*\d+\.?\d*(\s*:|\s+)/i)) {
                                outcomes.push(cleanedOutcome.trim());
                            }
                        }
                    } else if (line === '' && outcomes.length > 0) {
                        // Empty line after finding outcomes = end of table
                        break;
                    }
                }
            }
            return outcomes;
        }

        function extractGradebook(text) {
            const gradebookItems = [];
            // Find "CS: List items in the order in which they should be listed in the Gradebook"
            const headerIndex = text.indexOf("CS: List items in the order in which they should be listed in the Gradebook");
            if (headerIndex === -1) return [];

            const substring = text.substring(headerIndex);
            const lines = substring.split('\n');
            let insideTable = false;

            for (const line of lines) {
                if (line.includes('| Unit | Item Amount |')) {
                    insideTable = true;
                    continue;
                }
                if (line.includes(':----')) continue;

                if (insideTable) {
                    if (!line.startsWith('|')) {
                        if (gradebookItems.length > 0) break; // End of table
                        continue;
                    }

                    const parts = line.split('|').map(p => p.trim());
                    // Format: | Unit | Item Amount | ...
                    // parts[0] is empty (split), parts[1] is Name, parts[2] is Points
                    if (parts.length >= 3) {
                        const name = parts[1];
                        const points = parts[2];

                        // Filter out "Unit X" headers, keep only items with points
                        if (name && points && !name.match(/^\*\*Unit \d+\*\*$/) && points !== '') {
                            gradebookItems.push({ name, points });
                        }
                    }
                }
            }

            return gradebookItems;
        }

        function extractUnitOutcomesForSyllabus(text, courseCode) {
            const rawOutcomes = extractOutcomes(text, courseCode);
            // Sort by unit
            return rawOutcomes.sort((a, b) => {
                const uA = parseInt(a.unit) || 0;
                const uB = parseInt(b.unit) || 0;
                return uA - uB;
            });
        }

        function createSyllabusMarkdown(courseInfo, intro, outcomes, grading, unitOutcomes, standardLanguage) {
            let md = `# ${courseInfo.code}: ${courseInfo.title}\n\n`;

            md += `## What Will I Learn?\n\n${intro.whatLearn}\n\n`;

            md += `## How Will I Complete This Course?\n\n${intro.howComplete}\n\n`;

            md += `## Course Outcomes\n\n`;
            if (outcomes.length > 0) {
                outcomes.forEach(outcome => {
                    // Ensure nice formatting if it has "**"
                    md += `- ${outcome.replace(/\*\*/g, '')}\n`;
                });
            } else {
                md += `*No course outcomes found.*\n`;
            }
            md += `\n`;

            md += `## Grading and Assessment\n\n`;
            md += `| Graded Item | Points |\n|---|---|\n`;
            let totalPoints = 0;
            grading.forEach(item => {
                md += `| ${item.name} | ${item.points} |\n`;
                const p = parseInt(item.points);
                if (!isNaN(p)) totalPoints += p;
            });
            md += `| **Total** | **${totalPoints}** |\n\n`;

            md += `## Unit Learning Outcomes\n\n`;
            md += `| Unit | Outcomes |\n|---|---|\n`;

            // Group by unit
            let currentUnit = null;
            unitOutcomes.forEach(o => {
                if (o.unit !== currentUnit) {
                    md += `| **Unit ${o.unit}** | |\n`;
                    currentUnit = o.unit;
                }
                md += `| | • ${o.outcome} |\n`;
            });

            if (standardLanguage && standardLanguage.trim()) {
                md += `\n---\n\n${standardLanguage.trim()}\n`;
            }

            return md;
        }

        function downloadFile(content, filename, contentType) {
            const a = document.createElement('a');
            const file = new Blob([content], { type: contentType });
            a.href = URL.createObjectURL(file);
            a.download = filename;
            a.click();
            URL.revokeObjectURL(a.href);
        }

        // Convert outcomes to CSV
        function convertToCSV(outcomes) {
            if (outcomes.length === 0) {
                return 'Course Code,Unit,Outcome\n';
            }

            let csv = 'Course Code,Unit,Outcome\n';
            outcomes.forEach(item => {
                const escapedOutcome = item.outcome.replace(/"/g, '""');
                csv += `"${item.courseCode}","${item.unit}","${escapedOutcome}"\n`;
            });

            return csv;
        }

        // Storage for generated content (avoids issues with special chars in onclick)
        const generatedContent = {
            markdown: [],
            html: [],
            data: []
        };

        // Create UI Card for each result
        function createResultCard(filename, courseInfo, markdownContent, htmlContent, data) {
            // Store content and get index
            const idx = generatedContent.markdown.length;
            generatedContent.markdown.push(markdownContent);
            generatedContent.html.push(htmlContent);
            generatedContent.data.push(data);

            const card = document.createElement('div');
            card.className = 'course-section';
            card.innerHTML = `
                <div class="course-header" style="cursor: default;">
                    <div style="display: flex; align-items: center; gap: 15px;">
                        <h3>${courseInfo.code}: ${courseInfo.title}</h3>
                        <span class="course-count">Syllabus Generated</span>
                    </div>
                </div>
                <div class="course-table-container" style="text-align: center; padding: 30px;">
                    <p style="margin-bottom: 20px; color: var(--dark-gray);">Generated from: <strong>${filename}</strong></p>
                    <div class="actions" style="border: none; margin: 0; padding: 0;">
                        <button class="btn-primary" onclick="downloadMarkdown(${idx}, '${courseInfo.code}')">
                            Download Markdown
                        </button>
                        <button class="btn-primary" onclick="downloadPdf(${idx})">
                            Download PDF
                        </button>
                        <button class="btn-secondary" onclick="viewInNewTab(${idx})">
                            View in New Tab
                        </button>
                    </div>
                </div>
            `;
            const syllabusResults = document.getElementById('syllabusResults');
            syllabusResults.appendChild(card);
        }

        function downloadMarkdown(idx, courseCode) {
            const content = generatedContent.markdown[idx];
            const a = document.createElement('a');
            const file = new Blob([content], { type: 'text/markdown' });
            a.href = URL.createObjectURL(file);
            a.download = `${courseCode}_Syllabus.md`;
            a.click();
            URL.revokeObjectURL(a.href);
        }

        function downloadPdf(idx) {
            const data = generatedContent.data[idx];
            if (!data) return;

            try {
                const docDefinition = generatePdfDefinition(data);
                pdfMake.createPdf(docDefinition).download(`${data.courseInfo.code}_Syllabus.pdf`);
            } catch (e) {
                console.error('Error generating PDF:', e);
                alert('Error generating PDF. See console for details.');
            }
        }

        function parseSimpleMarkdown(text) {
            if (!text) return [];
            
            // Split by double newlines to get paragraphs
            const paragraphs = text.split(/\n\n+/);
            const content = [];

            paragraphs.forEach(para => {
                const trimmed = para.trim();
                if (!trimmed) return;

                // Headers
                if (trimmed.startsWith('#')) {
                    const level = trimmed.match(/^#+/)[0].length;
                    const cleanText = trimmed.replace(/^#+\s*/, '').replace(/\*\*/g, ''); // Remove bold markers from headers
                    
                    let style = 'body';
                    if (level === 1) style = 'header1';
                    else if (level === 2) style = 'header2';
                    else if (level === 3) style = 'header3';
                    else style = 'header3'; // fallback

                    content.push({ text: cleanText, style: style, margin: [0, 10, 0, 5] });
                    return;
                }

                // Lists
                if (trimmed.startsWith('- ') || trimmed.startsWith('* ') || trimmed.startsWith('• ')) {
                    const items = trimmed.split(/\n/).map(line => {
                        const lineText = line.replace(/^[-*•]\s+/, '');
                        return parseInlineFormatting(lineText);
                    });
                    content.push({ ul: items, margin: [0, 5, 0, 10] });
                    return;
                }

                // Normal paragraph with inline formatting
                content.push({ text: parseInlineFormatting(trimmed), margin: [0, 0, 0, 10] });
            });

            return content;
        }

        function parseInlineFormatting(text) {
            // Split by ** to find bold parts
            const parts = text.split(/(\*\*[^*]+\*\*)/g);
            return parts.map(part => {
                if (part.startsWith('**') && part.endsWith('**')) {
                    return { text: part.slice(2, -2), bold: true };
                }
                return part;
            });
        }

        function generatePdfDefinition(data) {
            const { courseInfo, intro, outcomes, grading, unitOutcomes, standardLanguage } = data;

            const docDefinition = {
                content: [
                    // Title
                    { text: `${courseInfo.code}: ${courseInfo.title}`, style: 'title' },
                    
                    // What Will I Learn
                    { text: 'What Will I Learn?', style: 'header2' },
                    ...parseSimpleMarkdown(intro.whatLearn),

                    // How Will I Complete
                    { text: 'How Will I Complete This Course?', style: 'header2' },
                    ...parseSimpleMarkdown(intro.howComplete),

                    // Course Outcomes
                    { text: 'Course Outcomes', style: 'header2' },
                ],
                styles: {
                    title: { fontSize: 24, bold: true, color: '#C28E0E', margin: [0, 0, 0, 20] },
                    header1: { fontSize: 18, bold: true, color: '#373A36', margin: [0, 15, 0, 10] },
                    header2: { fontSize: 16, bold: true, color: '#373A36', margin: [0, 15, 0, 10] },
                    header3: { fontSize: 14, bold: true, color: '#555555', margin: [0, 10, 0, 5] },
                    tableHeader: { bold: true, fontSize: 12, color: 'black', fillColor: '#eeeeee' },
                    unitHeader: { bold: true, color: '#C28E0E' }
                },
                defaultStyle: {
                    fontSize: 11,
                    lineHeight: 1.2
                }
            };

            // Add Course Outcomes
            if (outcomes && outcomes.length > 0) {
                const outcomeList = outcomes.map(o => parseInlineFormatting(o.replace(/^\*\*\s*/, '').replace(/\*\*$/, '')));
                docDefinition.content.push({ ul: outcomeList, margin: [0, 0, 0, 10] });
            } else {
                docDefinition.content.push({ text: 'No course outcomes found.', italics: true });
            }

            // Grading Table
            docDefinition.content.push({ text: 'Grading and Assessment', style: 'header2' });
            
            const gradingBody = [
                [{ text: 'Graded Item', style: 'tableHeader' }, { text: 'Points', style: 'tableHeader' }]
            ];
            
            let totalPoints = 0;
            grading.forEach(item => {
                gradingBody.push([item.name, item.points]);
                const p = parseInt(item.points);
                if (!isNaN(p)) totalPoints += p;
            });
            gradingBody.push([{ text: 'Total', bold: true }, { text: totalPoints.toString(), bold: true }]);

            docDefinition.content.push({
                table: {
                    headerRows: 1,
                    widths: ['*', 'auto'],
                    body: gradingBody
                },
                margin: [0, 5, 0, 15]
            });

            // Unit Outcomes Table
            docDefinition.content.push({ text: 'Unit Learning Outcomes', style: 'header2' });
            
            const unitBody = [
                [{ text: 'Unit', style: 'tableHeader' }, { text: 'Outcomes', style: 'tableHeader' }]
            ];

            // Group by unit
            const groupedOutcomes = {};
            unitOutcomes.forEach(o => {
                if (!groupedOutcomes[o.unit]) groupedOutcomes[o.unit] = [];
                groupedOutcomes[o.unit].push(o.outcome);
            });

            Object.keys(groupedOutcomes).sort((a, b) => parseInt(a) - parseInt(b)).forEach(unit => {
                const outcomesList = groupedOutcomes[unit];
                // Create a bulleted list for the outcomes in this unit
                const ul = { ul: outcomesList, margin: [0, 2, 0, 2] };
                
                unitBody.push([
                    { text: `Unit ${unit}`, bold: true, color: '#C28E0E' },
                    ul
                ]);
            });

            if (Object.keys(groupedOutcomes).length === 0) {
                 docDefinition.content.push({ text: 'No unit outcomes found.', italics: true });
            } else {
                docDefinition.content.push({
                    table: {
                        headerRows: 1,
                        widths: ['auto', '*'],
                        body: unitBody
                    },
                    margin: [0, 5, 0, 15]
                });
            }

            // Standard Language
            if (standardLanguage && standardLanguage.trim()) {
                 docDefinition.content.push({ text: '', pageBreak: 'before' }); // Optional page break? Or separator
                 docDefinition.content.push({ canvas: [{ type: 'line', x1: 0, y1: 5, x2: 515, y2: 5, lineWidth: 1 }] });
                 docDefinition.content.push({ text: 'Standard Syllabus Language', style: 'header2', margin: [0, 20, 0, 10] });
                 docDefinition.content.push(...parseSimpleMarkdown(standardLanguage));
            }

            return docDefinition;
        }

        function viewInNewTab(idx) {
            const htmlContent = generatedContent.html[idx];
            const newTab = window.open('', '_blank');
            newTab.document.write(htmlContent);
            newTab.document.close();
        }

        function createSyllabusHtml(courseInfo, intro, outcomes, grading, unitOutcomes, standardLanguage) {
            // Helper to convert markdown bold **text** to HTML <strong>
            function markdownToHtml(text, addLineBreaksForKeywords = false) {
                if (!text) return '';
                let result = text
                    // Convert headings
                    .replace(/^######\s+(.+)$/gm, '<h6>$1</h6>')
                    .replace(/^#####\s+(.+)$/gm, '<h5>$1</h5>')
                    .replace(/^####\s+(.+)$/gm, '<h4>$1</h4>')
                    .replace(/^###\s+(.+)$/gm, '<h3>$1</h3>')
                    .replace(/^##\s+(.+)$/gm, '<h2>$1</h2>')
                    .replace(/^#\s+(.+)$/gm, '<h1>$1</h1>')
                    // Convert **text** to <strong>text</strong>
                    .replace(/\*\*([^*]+)\*\*/g, '<strong>$1</strong>')
                    .replace(/\n/g, '<br>');

                // Add line breaks before activity keywords for "How Will I Complete" section
                if (addLineBreaksForKeywords) {
                    result = result
                        .replace(/(<strong>Reading:<\/strong>)/gi, '<br><br>$1')
                        .replace(/(<strong>Discussion:<\/strong>)/gi, '<br><br>$1')
                        .replace(/(<strong>Assignment:<\/strong>)/gi, '<br><br>$1')
                        .replace(/(<strong>Seminar:<\/strong>)/gi, '<br><br>$1')
                        .replace(/(<strong>Quiz:<\/strong>)/gi, '<br><br>$1');
                }
                return result;
            }

            // Group unit outcomes by unit number
            const groupedOutcomes = {};
            unitOutcomes.forEach(o => {
                if (!groupedOutcomes[o.unit]) {
                    groupedOutcomes[o.unit] = [];
                }
                groupedOutcomes[o.unit].push(o.outcome);
            });

            // Build unit outcomes HTML
            let unitOutcomesHtml = '';
            Object.keys(groupedOutcomes).sort((a, b) => parseInt(a) - parseInt(b)).forEach(unit => {
                unitOutcomesHtml += `<h3>Unit ${unit}</h3><ul>`;
                groupedOutcomes[unit].forEach(outcome => {
                    unitOutcomesHtml += `<li>${outcome}</li>`;
                });
                unitOutcomesHtml += `</ul>`;
            });

            const standardLanguageHtml = standardLanguage && standardLanguage.trim()
                ? `<h2>Standard Syllabus Language</h2><div>${markdownToHtml(standardLanguage)}</div>`
                : '';

            return `
            <!DOCTYPE html>
            <html>
            <head>
                <title>${courseInfo.code} Syllabus</title>
                <style>
                    body { font-family: Arial, sans-serif; line-height: 1.6; max-width: 900px; margin: 0 auto; padding: 40px; }
                    h1 { color: #C28E0E; border-bottom: 2px solid #000; padding-bottom: 10px; }
                    h2 { color: #373A36; margin-top: 30px; border-bottom: 1px solid #ddd; padding-bottom: 5px; }
                    h3 { color: #555; margin-top: 20px; margin-bottom: 10px; }
                    table { width: 100%; border-collapse: collapse; margin: 20px 0; }
                    th, td { border: 1px solid #ddd; padding: 12px; text-align: left; }
                    th { background-color: #f8f8f8; font-weight: bold; }
                    ul { margin-left: 20px; margin-bottom: 15px; }
                    @media print {
                        body { padding: 20px; }
                        h2 { page-break-after: avoid; }
                        h3 { page-break-after: avoid; }
                    }
                </style>
            </head>
            <body>
                <h1>${courseInfo.code}: ${courseInfo.title}</h1>
                
                <h2>What Will I Learn?</h2>
                <p>${markdownToHtml(intro.whatLearn)}</p>
                
                <h2>How Will I Complete This Course?</h2>
                <p>${markdownToHtml(intro.howComplete, true)}</p>
                
                <h2>Course Outcomes</h2>
                <ul>${outcomes.length > 0 ? outcomes.map(o => `<li>${o.replace(/\*\*/g, '')}</li>`).join('') : '<li>No course outcomes found.</li>'}</ul>
                
                <h2>Grading and Assessment</h2>
                <table>
                    <tr><th>Graded Item</th><th>Points</th></tr>
                    ${grading.map(i => `<tr><td>${i.name}</td><td>${i.points}</td></tr>`).join('')}
                    <tr><td><strong>Total</strong></td><td><strong>${grading.reduce((a, b) => a + (parseInt(b.points) || 0), 0)}</strong></td></tr>
                </table>
                
                <h2>Unit Learning Outcomes</h2>
                ${unitOutcomesHtml || '<p>No unit outcomes found.</p>'}

                ${standardLanguageHtml}
            </body>
            </html>
            `;
        }

        function sanitizeStandardLanguage(text) {
            const lines = text.split(/\r?\n/);
            const cleaned = lines.map((line, idx) => {
                const headingMatch = line.match(/^(#{2,6})\s+(.*)$/);
                if (!headingMatch) return line;

                const prevLine = idx > 0 ? lines[idx - 1] : '';
                const prevTrim = prevLine.trim();
                const hasPrev = prevTrim.length > 0;
                const prevEndsSentence = /[.!?;:]$/.test(prevTrim);

                if (hasPrev && !prevEndsSentence) {
                    return headingMatch[2];
                }

                return line;
            });

            return cleaned.join('\n');
        }

        // Process the markdown files
        async function processFiles() {
            if (selectedFiles.length === 0) return;

            // Hide error if showing
            error.style.display = 'none';

            // Show loading
            loading.style.display = 'block';

            // HIDE UPLOAD SECTION
            document.querySelector('.upload-section').style.display = 'none';

            // Clear previous results
            document.getElementById('syllabusResults').innerHTML = '';
            generatedContent.markdown = [];
            generatedContent.html = [];
            generatedContent.data = [];

            try {
                let standardLanguage = '';
                if (includeStandardLanguage.checked) {
                    if (!standardLanguageFile) {
                        throw new Error('Please upload the standard syllabus language .md file before processing.');
                    }
                    standardLanguage = sanitizeStandardLanguage(await extractTextFromMarkdown(standardLanguageFile));
                }

                // Process each Markdown file
                for (const file of selectedFiles) {
                    const text = await extractTextFromMarkdown(file);

                    // Extract all needed data
                    const courseInfo = extractCourseInfo(text);
                    const intro = extractIntroSections(text);
                    const outcomes = extractCourseOutcomes(text);
                    const grading = extractGradebook(text);
                    const unitOutcomes = extractUnitOutcomesForSyllabus(text, courseInfo.code);

                    // Generate syllabus content
                    const syllabusMarkdown = createSyllabusMarkdown(courseInfo, intro, outcomes, grading, unitOutcomes, standardLanguage);
                    const syllabusHtml = createSyllabusHtml(courseInfo, intro, outcomes, grading, unitOutcomes, standardLanguage);

                    // Create the result card with download buttons
                    const data = { courseInfo, intro, outcomes, grading, unitOutcomes, standardLanguage };
                    createResultCard(file.name, courseInfo, syllabusMarkdown, syllabusHtml, data);
                }

                // Hide loading
                loading.style.display = 'none';

                // Show results section
                resultsSection.style.display = 'block';

            } catch (err) {
                loading.style.display = 'none';
                showError(err.message || 'An error occurred while processing the files');
                console.error(err);
                // If error, show upload section again
                document.querySelector('.upload-section').style.display = 'block';
            }
        }

        // Display results
        function displayResults(outcomes, csv) {
            csvData = csv;

            // Group outcomes by course code
            const courseGroups = {};
            outcomes.forEach(outcome => {
                if (!courseGroups[outcome.courseCode]) {
                    courseGroups[outcome.courseCode] = [];
                }
                courseGroups[outcome.courseCode].push(outcome);
            });

            // Populate course sections
            const courseResults = document.getElementById('courseResults');
            courseResults.innerHTML = '';

            Object.keys(courseGroups).sort().forEach(courseCode => {
                const courseOutcomes = courseGroups[courseCode];

                // Validate units for this course
                const validation = validateUnits(outcomes, courseCode);

                const courseSection = document.createElement('div');
                courseSection.className = 'course-section';

                // Build warning HTML if units are missing
                let warningHTML = '';
                if (!validation.isComplete) {
                    warningHTML = `
                        <div class="validation-warning">
                            <div class="validation-warning-icon">⚠️</div>
                            <div class="validation-warning-content">
                                <p class="validation-warning-title">Incomplete Unit Coverage Detected</p>
                                <p class="validation-warning-text">
                                    Expected 10 units, but only found ${validation.totalFound} unit${validation.totalFound !== 1 ? 's' : ''} with outcomes.
                                    <br>
                                    <span class="validation-warning-missing">Missing units: ${validation.missingUnits.join(', ')}</span>
                                    <br>
                                    Please manually verify the source file to ensure all units are present and properly formatted.
                                </p>
                            </div>
                        </div>
                    `;
                }

                courseSection.innerHTML = `
                    <div class="course-header" onclick="toggleCourse('${courseCode}')">
                        <div style="display: flex; align-items: center; gap: 15px;">
                            <h3>${courseCode}</h3>
                            <span class="course-count">${courseOutcomes.length} outcomes</span>
                            ${!validation.isComplete ? '<span style="font-size: 1.2em; margin-left: 5px;">⚠️</span>' : ''}
                        </div>
                        <span class="course-toggle" id="toggle-${courseCode}">▼</span>
                    </div>
                    <div class="course-content" id="content-${courseCode}">
                        <div class="course-table-container">
                            ${warningHTML}
                            <table class="results-table">
                                <thead>
                                    <tr>
                                        <th style="width: 80px;">Unit</th>
                                        <th>Outcome</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    ${courseOutcomes.map(outcome => `
                                        <tr>
                                            <td style="text-align: center; font-weight: 600;">${outcome.unit}</td>
                                            <td>${outcome.outcome}</td>
                                        </tr>
                                    `).join('')}
                                </tbody>
                            </table>
                        </div>
                    </div>
                `;

                courseResults.appendChild(courseSection);
            });

            // Show results section
            resultsSection.style.display = 'block';
        }

        // Toggle course section
        function toggleCourse(courseCode) {
            const content = document.getElementById(`content-${courseCode}`);
            const toggle = document.getElementById(`toggle-${courseCode}`);

            if (content.classList.contains('expanded')) {
                content.classList.remove('expanded');
                toggle.classList.remove('expanded');
            } else {
                content.classList.add('expanded');
                toggle.classList.add('expanded');
            }
        }

        // Download CSV
        function downloadCSV() {
            const blob = new Blob([csvData], { type: 'text/csv' });
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `unit-outcomes-${new Date().toISOString().split('T')[0]}.csv`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            window.URL.revokeObjectURL(url);
        }

        // Reset the application
        function reset() {
            selectedFiles = [];
            csvData = '';
            fileInput.value = '';
            fileList.innerHTML = '';
            resultsSection.style.display = 'none';
            document.querySelector('.upload-section').style.display = 'block';
            error.style.display = 'none';
            includeStandardLanguage.checked = false;
            standardLanguageFile = null;
            standardFileInput.value = '';
            standardUploadBox.style.display = 'none';
            standardFileList.style.display = 'none';
            updateStandardFileList();
            updateProcessButton();
        }

        function initFormState() {
            includeStandardLanguage.checked = false;
            standardLanguageFile = null;
            standardFileInput.value = '';
            toggleStandardLanguageUpload();
            updateProcessButton();
        }

        initFormState();

        // Show error message
        function showError(message) {
            errorMessage.textContent = message;
            error.style.display = 'flex';
            document.querySelector('.upload-section').style.display = 'block';
        }
    </script>
</body>

</html>
